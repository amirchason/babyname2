name: V13 Enrichment Pipeline

on:
  workflow_dispatch:
    inputs:
      batchSize:
        description: 'Number of names to process (or "all")'
        required: true
        default: '50'
        type: string
      forceAll:
        description: 'Force process all 1000 names'
        required: false
        default: false
        type: boolean

  # Allow manual trigger from GitHub CLI or API
  repository_dispatch:
    types: [enrich-v13-batch]

jobs:
  enrich:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours maximum

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history for proper commits

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm install --legacy-peer-deps

      - name: ğŸ”‘ Configure Git
        run: |
          git config --global user.name "V13 Enrichment Bot"
          git config --global user.email "actions@github.com"

      - name: ğŸ“Š Show current state
        run: |
          echo "ğŸ“Š Current Enrichment State:"
          if [ -f public/data/enrichment-state.json ]; then
            cat public/data/enrichment-state.json
          else
            echo "No state file found - starting fresh"
          fi

      - name: ğŸš€ Run V13 Enrichment
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ "${{ inputs.forceAll }}" == "true" ]; then
            echo "ğŸ¯ Force processing ALL remaining names"
            node scripts/enrich-v13-master.js all
          else
            echo "ğŸ¯ Processing batch of ${{ inputs.batchSize }} names"
            node scripts/enrich-v13-master.js ${{ inputs.batchSize }}
          fi

      - name: ğŸ“‹ Show results
        if: always()
        run: |
          echo "ğŸ“Š Enrichment Results:"
          if [ -f public/data/enrichment-state.json ]; then
            cat public/data/enrichment-state.json | jq '.stats'
          fi

          echo ""
          echo "ğŸ“ Latest log entries:"
          if [ -f scripts/enrich-v13-master.log ]; then
            tail -50 scripts/enrich-v13-master.log
          fi

      - name: ğŸ’¾ Commit enriched data
        if: success()
        run: |
          # Add all enriched files
          git add public/data/enriched/*.json || true
          git add public/data/enrichment-state.json || true
          git add scripts/enrich-v13-master.log || true

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Count new v13 files
            V13_COUNT=$(git diff --staged --name-only | grep -c "v13.json" || echo "0")
            echo "ğŸ“¦ Committing $V13_COUNT new v13 enrichments"

            git commit -m "feat: V13 enrichment batch complete - $V13_COUNT names enriched

ğŸ¤– Auto-generated by GitHub Actions
ğŸ“Š Batch size: ${{ inputs.batchSize }}
â° Completed: $(date -u +%Y-%m-%dT%H:%M:%SZ)

Co-Authored-By: V13 Enrichment Bot <actions@github.com>"

            git push
            echo "âœ… Changes pushed to repository"
          fi

      - name: ğŸ“ˆ Update PR or Issue (optional)
        if: success()
        run: |
          echo "ğŸ“ˆ Enrichment batch complete!"
          echo "Run another batch with: gh workflow run enrich-v13-batch.yml -f batchSize=50"

      - name: âŒ Handle failure
        if: failure()
        run: |
          echo "âŒ Enrichment failed. Check logs above."
          echo "State file preserved for resume. Run workflow again to continue."
          exit 1

      - name: ğŸ“¤ Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: enrichment-logs-${{ github.run_number }}
          path: |
            scripts/enrich-v13-master.log
            public/data/enrichment-state.json
          retention-days: 30
